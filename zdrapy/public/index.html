<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zdrapki – Vercel + Neon (Postgres)</title>
  <style>
    :root{--bg:#0b0b0f;--card:#15151c;--ink:#e9e9ef;--muted:#a2a2b2;--ok:#18a957;--bad:#e45858}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto;background:var(--bg);color:var(--ink)}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.25);padding:20px;margin:16px 0}
    input,button{background:#1c1c26;color:var(--ink);border:1px solid #2a2a35;border-radius:10px;padding:10px 12px}
    button{cursor:pointer}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .qr{width:140px;height:140px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#222;color:var(--muted);font-size:12px}
    a{color:#7fb3ff}
    @media print{ .noprint{display:none} body{background:#fff;color:#000} .ticket{width:58mm;padding:0;margin:0} .ticket *{font-family:monospace} .tk-line{border-top:1px dashed #000;margin:8px 0} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card"><h1>Zdrapki – Vercel + Neon</h1>
      <p>API w <b>Vercel serverless</b>, baza <b>Postgres (Neon)</b>. QR i druk gotowe.</p>
      <div class="grid noprint">
        <a class="card" href="#" id="go-admin"><h3>Panel admin</h3><p>Generowanie, lista i druk testowy.</p></a>
        <a class="card" href="#" id="go-check"><h3>Sprawdź kod</h3><p>Wejście klienta.</p></a>
      </div>
    </div>

    <div class="card" id="view-admin" style="display:none">
      <h2>Panel admin</h2>
      <form class="grid noprint" id="form-gen">
        <div><label>Ile kodów?<br><input type="number" name="count" min="1" max="1000" value="10"></label></div>
        <div><label>Opis nagrody (opcjonalnie)<br><input name="prize" placeholder="np. -10% / kawa gratis"></label></div>
        <div style="align-self:end"><button>Generuj</button></div>
      </form>
      <div id="generated" class="grid"></div>
      <div class="card"><h3>Ostatnie</h3><div id="last-codes"></div></div>
    </div>

    <div class="card" id="view-check" style="display:none">
      <h2>Sprawdź zdrapkę</h2>
      <form class="grid" id="form-check">
        <div><label>Wpisz kod<br><input name="code" placeholder="ABCDE-12345" required></label></div>
        <div style="align-self:end"><button>Sprawdź</button></div>
      </form>
      <div id="check-result"></div>
    </div>

    <div class="card noprint"><small>© Vercel + Neon</small></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script>
    const qs = s=>document.querySelector(s);
    const elGen = (html)=>{ const d=document.createElement('div'); d.innerHTML=html; return d.firstElementChild; };
    const fmtUrl = (code)=> location.origin + '/?check&code=' + encodeURIComponent(code);
    const show = (view)=>{ qs('#view-admin').style.display = view==='admin'?'block':'none'; qs('#view-check').style.display = view==='check'?'block':'none'; };
    qs('#go-admin').onclick = e=>{e.preventDefault(); show('admin'); loadLast();};
    qs('#go-check').onclick = e=>{e.preventDefault(); show('check');};

    async function api(path, opts){
      const res = await fetch(path, opts);
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }

    qs('#form-gen').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const count = Math.max(1, Math.min(1000, parseInt(fd.get('count')||'1')));
      const prize = (fd.get('prize')||'').trim();
      const out = qs('#generated'); out.innerHTML='Generuję...';
      try{
        const data = await api('/api/create', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({count, prize})});
        out.innerHTML='';
        data.codes.forEach(c=>{
          const url = fmtUrl(c);
          const card = elGen(`<div class="card"><div id="qr_${c}" class="qr"></div><div><b>${c}</b><br><small>${url}</small><br><a href="#" data-print="${c}" target="_blank">Wydruk testowy</a></div></div>`);
          out.appendChild(card);
          new QRCode(card.querySelector('#qr_'+CSS.escape(c)), {text:url, width:140, height:140, correctLevel: QRCode.CorrectLevel.M});
        });
        loadLast();
      }catch(err){ out.innerHTML = '<span style="color:#e45858">Błąd: '+err.message+'</span>'; }
    });

    async function loadLast(){
      const box = qs('#last-codes'); box.innerHTML='Ładowanie...';
      try{
        const data = await api('/api/list');
        box.innerHTML='';
        data.rows.forEach(r=>{
          const row = elGen(`<div style="margin:6px 0">`+
            `<b>${r.code}</b> • ${r.prize||''} `+
            `<span class="pill">${r.redeemed_at? 'Wykorzystany':'Nowy'}</span> `+
            ` • <a target="_blank" href="${fmtUrl(r.code)}">Link</a> `+
            ` • <a target="_blank" href="#" data-print="${r.code}">Druk</a>`+
          `</div>`);
          box.appendChild(row);
        });
      }catch(err){ box.innerHTML = 'Błąd: '+err.message; }
    }

    qs('#form-check').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const code = (new FormData(e.target).get('code')||'').toUpperCase().trim();
      const out = qs('#check-result'); out.innerHTML='Sprawdzam...';
      try{
        const data = await api('/api/check?code='+encodeURIComponent(code));
        if(!data.found){ out.innerHTML = '<p class="card" style="color:var(--bad)">Nieprawidłowy kod.</p>'; return; }
        if(data.redeemed_at){ out.innerHTML = `<p class="card">Kod został już wykorzystany <b>${data.redeemed_at}</b>.</p>`; return; }
        const prize = data.prize || 'Niespodzianka!';
        out.innerHTML = `<div class="card"><h3>Gratulacje!</h3><p>Twoja nagroda: <b>${prize}</b></p>`+
          `<a class="pill" href="#" id="do-redeem">Oznacz jako wykorzystany</a></div>`;
        qs('#do-redeem').onclick = async (ev)=>{
          ev.preventDefault();
          try{
            const r = await api('/api/redeem', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({code})});
            out.innerHTML = `<p class="card" style="color:var(--ok)">Zrealizowano! (${r.redeemed_at})</p>`;
          }catch(err){ out.innerHTML = 'Błąd: '+err.message; }
        };
      }catch(err){ out.innerHTML = 'Błąd: '+err.message; }
    });

    document.addEventListener('click', async (e)=>{
      const a = e.target.closest('a[data-print]'); if(!a) return; e.preventDefault();
      const code = a.getAttribute('data-print');
      const data = await api('/api/check?code='+encodeURIComponent(code));
      if(!data.found) return alert('Kod nie istnieje');
      const url = fmtUrl(code);
      const w = window.open('', '_blank');
      w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Druk</title>`+
        `<style>@media print{ .ticket{width:58mm} .ticket *{font-family:monospace} .tk-line{border-top:1px dashed #000;margin:8px 0} }</style>`+
        `</head><body><div class="ticket">`+
        `<h2>ZDrapka</h2><div class="tk-line"></div>`+
        `<div id="qr" style="width:140px;height:140px"></div>`+
        `<div class="tk-line"></div>`+
        `<div><b>Kod:</b> ${code}</div>`+
        `<div><b>Nagroda:</b> ${data.prize||'niespodzianka'}</div>`+
        `<div>Sprawdź: ${url}</div>`+
        `<div class="tk-line"></div><div style="font-size:12px">Jednorazowy.</div>`+
        `</div><script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>`+
        `<script>new QRCode(document.getElementById('qr'), {text: '${url}', width:140, height:140, correctLevel: QRCode.CorrectLevel.M}); window.print();<\/script>`+
        `</body></html>`);
      w.document.close();
    });

    const params = new URLSearchParams(location.search);
    if(params.has('check')){ show('check'); const c=params.get('code')||''; qs('#form-check').code.value=c; if(c) qs('#form-check').dispatchEvent(new Event('submit')); }
  </script>
</body>
</html>
